# ========================================
# PyPI è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
# ========================================
# åŠŸèƒ½è¯´æ˜ï¼š
#   1. æ¯ä¸¤å¤©è‡ªåŠ¨è¿è¡Œä¸€æ¬¡ï¼ˆå‡Œæ™¨0ç‚¹ï¼‰
#   2. ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘è¿è¡Œ
#   3. è‡ªåŠ¨æ£€æµ‹æ˜¯å¦æœ‰æ–°æäº¤ï¼ˆæœ€è¿‘3å¤©å†…ï¼‰
#   4. æœ‰æ–°æäº¤æ‰è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒåˆ° PyPI
# ========================================

name: å‘å¸ƒåˆ° PyPI  # å·¥ä½œæµçš„åç§°

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶è§¦å‘ï¼šæ¯ä¸¤å¤©è¿è¡Œä¸€æ¬¡ï¼ˆåœ¨æ¯æœˆçš„å¥‡æ•°æ—¥å’Œå¶æ•°æ—¥çš„ 00:00 UTC è¿è¡Œï¼‰
  schedule:
    - cron: '0 0 */2 * *'  # cron æ ¼å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ æ˜ŸæœŸï¼Œ*/2 è¡¨ç¤ºæ¯ä¸¤å¤©
  
  # æ‰‹åŠ¨è§¦å‘ï¼šå¯ä»¥åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'æ˜¯å¦ä¸ºæµ‹è¯•è¿è¡Œï¼ˆä¸å®é™…å‘å¸ƒï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# å·¥ä½œæµä»»åŠ¡
jobs:
  # æ„å»ºå’Œå‘å¸ƒä»»åŠ¡
  build-and-publish:
    name: æ„å»ºå¹¶å‘å¸ƒ Python åŒ…åˆ° PyPI
    runs-on: ubuntu-latest  # ä½¿ç”¨ Ubuntu æœ€æ–°ç‰ˆæœ¬ä½œä¸ºè¿è¡Œç¯å¢ƒ
    
    # æ‰§è¡Œæ­¥éª¤
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # ä» GitHub ä»“åº“ä¸­æ‹‰å–ä»£ç åˆ°è¿è¡Œç¯å¢ƒ
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ Git å†å²è®°å½•
      
      # æ­¥éª¤ 2: æ£€æµ‹æ˜¯å¦æœ‰æ–°æäº¤
      # æ£€æŸ¥æœ€è¿‘3å¤©å†…æ˜¯å¦æœ‰æ–°çš„æäº¤ï¼Œå¦‚æœæ²¡æœ‰åˆ™è·³è¿‡åç»­æ­¥éª¤
      - name: ğŸ” æ£€æµ‹æ–°æäº¤
        id: check_commits
        run: |
          # è·å–æœ€è¿‘ä¸€æ¬¡æäº¤çš„æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
          LAST_COMMIT_TIME=$(git log -1 --format=%ct)
          # è·å–å½“å‰æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
          CURRENT_TIME=$(date +%s)
          # è®¡ç®—æ—¶é—´å·®ï¼ˆç§’ï¼‰
          TIME_DIFF=$((CURRENT_TIME - LAST_COMMIT_TIME))
          # 3å¤© = 3 * 24 * 60 * 60 = 259200 ç§’
          THREE_DAYS=259200
          
          echo "æœ€åä¸€æ¬¡æäº¤æ—¶é—´: $(date -d @$LAST_COMMIT_TIME +'%Y-%m-%d %H:%M:%S')"
          echo "è·ç¦»ç°åœ¨: $((TIME_DIFF / 86400)) å¤© $(((TIME_DIFF % 86400) / 3600)) å°æ—¶"
          
          if [ $TIME_DIFF -le $THREE_DAYS ]; then
            echo "âœ… æ£€æµ‹åˆ°æœ€è¿‘3å¤©å†…æœ‰æ–°æäº¤ï¼Œç»§ç»­å‘å¸ƒæµç¨‹"
            echo "has_new_commits=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ æœ€è¿‘3å¤©å†…æ²¡æœ‰æ–°æäº¤ï¼Œè·³è¿‡å‘å¸ƒ"
            echo "has_new_commits=false" >> $GITHUB_OUTPUT
          fi
      
      # æ­¥éª¤ 3: è®¾ç½® Python ç¯å¢ƒ
      # å®‰è£… Python 3.11 ç‰ˆæœ¬
      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        # åªæœ‰æ£€æµ‹åˆ°æ–°æäº¤æˆ–æ‰‹åŠ¨è¿è¡Œæ—¶æ‰æ‰§è¡Œ
        if: steps.check_commits.outputs.has_new_commits == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # ä½¿ç”¨ Python 3.11
          cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–ï¼ŒåŠ å¿«åç»­è¿è¡Œé€Ÿåº¦
      
      # æ­¥éª¤ 4: å®‰è£…æ„å»ºå·¥å…·
      # å®‰è£…æ‰“åŒ…æ‰€éœ€çš„å·¥å…·ï¼šbuildï¼ˆæ„å»ºå·¥å…·ï¼‰å’Œ twineï¼ˆä¸Šä¼ å·¥å…·ï¼‰
      - name: ğŸ“¦ å®‰è£…æ„å»ºå·¥å…·        if: steps.check_commits.outputs.has_new_commits == 'true' || github.event_name == 'workflow_dispatch'        run: |
          python -m pip install --upgrade pip  # å‡çº§ pip åˆ°æœ€æ–°ç‰ˆæœ¬
          pip install build twine  # å®‰è£… build å’Œ twine
      
      # æ­¥éª¤ 5: æ„å»º Python åŒ…
      # ä½¿ç”¨ build å·¥å…·æ„å»ºæºä»£ç åŒ…å’ŒäºŒè¿›åˆ¶åŒ…
      - name: ğŸ”¨ æ„å»º Python åŒ…
        if: steps.check_commits.outputs.has_new_commits == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          python -m build  # æ„å»ºåŒ…ï¼Œç”Ÿæˆ dist/ ç›®å½•
      
      # æ­¥éª¤ 6: æ£€æŸ¥æ„å»ºçš„åŒ…
      # ä½¿ç”¨ twine æ£€æŸ¥åŒ…æ˜¯å¦ç¬¦åˆ PyPI è§„èŒƒ
      - name: ğŸ” æ£€æŸ¥æ„å»ºçš„åŒ…
        if: steps.check_commits.outputs.has_new_commits == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          twine check dist/*  # æ£€æŸ¥ dist/ ç›®å½•ä¸‹çš„æ‰€æœ‰åŒ…æ–‡ä»¶
      
      # æ­¥éª¤ 7: å‘å¸ƒåˆ° PyPI
      # ä½¿ç”¨ twine å°†åŒ…ä¸Šä¼ åˆ° PyPI
      # æ³¨æ„ï¼šéœ€è¦åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  PYPI_API_TOKEN å¯†é’¥
      - name: ğŸš€ å‘å¸ƒåˆ° PyPI
        # åªæœ‰åœ¨éæµ‹è¯•è¿è¡Œã€æœ‰æ–°æäº¤æˆ–æ‰‹åŠ¨è¿è¡Œæ—¶æ‰æ‰§è¡Œå‘å¸ƒ
        if: ${{ (steps.check_commits.outputs.has_new_commits == 'true' || github.event_name == 'workflow_dispatch') && github.event.inputs.dry_run != 'true' }}
        env:
          TWINE_USERNAME: __token__  # PyPI ä½¿ç”¨ token è®¤è¯æ—¶çš„ç”¨æˆ·åå›ºå®šä¸º __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}  # ä» GitHub Secrets ä¸­è·å– PyPI API Token
        run: |
          twine upload dist/*  # ä¸Šä¼ æ‰€æœ‰æ„å»ºå¥½çš„åŒ…åˆ° PyPI
      
      # æ­¥éª¤ 8: æµ‹è¯•è¿è¡Œæç¤º
      # å¦‚æœæ˜¯æµ‹è¯•è¿è¡Œï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
      - name: â„¹ï¸ æµ‹è¯•è¿è¡Œæç¤º
        if: ${{ (steps.check_commits.outputs.has_new_commits == 'true' || github.event_name == 'workflow_dispatch') && github.event.inputs.dry_run == 'true' }}
        run: |
          echo "ğŸ§ª è¿™æ˜¯ä¸€æ¬¡æµ‹è¯•è¿è¡Œï¼ŒåŒ…å·²æ„å»ºä½†æœªå‘å¸ƒåˆ° PyPI"
          echo "ğŸ“¦ æ„å»ºçš„åŒ…æ–‡ä»¶ï¼š"
          ls -lh dist/

# ========================================
# ä½¿ç”¨è¯´æ˜ï¼š
# ========================================
# 1. åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  Secretï¼š
#    - åç§°ï¼šPYPI_API_TOKEN
#    - å€¼ï¼šä½ çš„ PyPI API Tokenï¼ˆä» https://pypi.org/manage/account/token/ è·å–ï¼‰
#
# 2. è‡ªåŠ¨è¿è¡Œï¼š
#    - å·¥ä½œæµä¼šæ¯ä¸¤å¤©è‡ªåŠ¨è¿è¡Œä¸€æ¬¡
#    - è¿è¡Œæ—¶é—´ä¸º UTC æ—¶é—´ 00:00ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
#
# 3. æ‰‹åŠ¨è¿è¡Œï¼š
#    - è¿›å…¥ GitHub ä»“åº“çš„ Actions é¡µé¢
#    - é€‰æ‹© "å‘å¸ƒåˆ° PyPI" å·¥ä½œæµ
#    - ç‚¹å‡» "Run workflow" æŒ‰é’®
#    - å¯é€‰æ‹©æ˜¯å¦ä¸ºæµ‹è¯•è¿è¡Œ
#
# 4. è‡ªåŠ¨æ£€æµ‹æœºåˆ¶ï¼š
#    - å·¥ä½œæµä¼šè‡ªåŠ¨æ£€æµ‹æœ€è¿‘3å¤©å†…æ˜¯å¦æœ‰æ–°æäº¤
#    - æ²¡æœ‰æ–°æäº¤æ—¶ä¼šè‡ªåŠ¨è·³è¿‡å‘å¸ƒï¼ŒèŠ‚çœèµ„æº
#    - æ‰‹åŠ¨è§¦å‘æ—¶ä¼šå¿½ç•¥æ£€æµ‹ï¼Œå§‹ç»ˆæ‰§è¡Œå‘å¸ƒ
#
# 5. æ³¨æ„äº‹é¡¹ï¼š
#    - ç¡®ä¿ pyproject.toml ä¸­çš„ç‰ˆæœ¬å·å·²æ›´æ–°
#    - PyPI ä¸å…è®¸é‡å¤ä¸Šä¼ ç›¸åŒç‰ˆæœ¬å·çš„åŒ…
#    - å»ºè®®å…ˆä½¿ç”¨æµ‹è¯•è¿è¡ŒéªŒè¯æ„å»ºè¿‡ç¨‹
# ========================================
