# Phase 3: ä»£ç ç”Ÿæˆå‘½ä»¤ - è¯¦ç»†ä»»åŠ¡æ¸…å•

> **å¼€å§‹æ—¥æœŸ**: 2025å¹´12æœˆ13æ—¥
> **é¢„è®¡å®Œæˆ**: 2-3 å‘¨
> **çŠ¶æ€**: ğŸš€ å¯åŠ¨ä¸­

---

## æ¦‚è§ˆ

Phase 3 çš„ç›®æ ‡æ˜¯å®ç°å®Œæ•´çš„ `mpdt generate` å‘½ä»¤,å…è®¸å¼€å‘è€…åœ¨ç°æœ‰æ’ä»¶ä¸­å¿«é€Ÿç”Ÿæˆå„ç§ç»„ä»¶(Actionã€Commandã€Tool ç­‰)ã€‚

## æ ¸å¿ƒåŠŸèƒ½

### 1. ç»„ä»¶æ¨¡æ¿ç³»ç»Ÿ

éœ€è¦ä¸ºæ¯ç§ç»„ä»¶ç±»å‹åˆ›å»ºå®Œæ•´çš„ä»£ç æ¨¡æ¿:

#### 1.1 Action ç»„ä»¶ â¬œ
**ä¼˜å…ˆçº§**: é«˜

**æ¨¡æ¿å†…å®¹**:
- ç»§æ‰¿è‡ª `BaseAction`
- å®Œæ•´çš„ç±»å‹æ³¨è§£
- æ–‡æ¡£å­—ç¬¦ä¸²(åŒ…å«å‚æ•°ã€è¿”å›å€¼è¯´æ˜)
- `execute` æ–¹æ³•çš„åŸºæœ¬å®ç°
- é”™è¯¯å¤„ç†ç¤ºä¾‹

**ç”Ÿæˆæ–‡ä»¶**:
- `components/actions/<action_name>.py` - Action ç±»å®šä¹‰
- `tests/test_actions/test_<action_name>.py` - å•å…ƒæµ‹è¯•(å¯é€‰)

**ç¤ºä¾‹ä»£ç ç»“æ„**:
```python
from src.plugin_system import BaseAction

class {ActionName}Action(BaseAction):
    """
    {description}
    
    Args:
        param1: å‚æ•°1è¯´æ˜
        param2: å‚æ•°2è¯´æ˜
    
    Returns:
        æ‰§è¡Œç»“æœ
    """
    
    async def execute(self, context, **kwargs):
        # TODO: å®ç°ä½ çš„é€»è¾‘
        pass
```

#### 1.2 Command ç»„ä»¶ â¬œ
**ä¼˜å…ˆçº§**: é«˜

**æ¨¡æ¿å†…å®¹**:
- ç»§æ‰¿è‡ª `BaseCommand`
- å‘½ä»¤åç§°å’Œåˆ«å
- æƒé™æ£€æŸ¥
- å‚æ•°è§£æ
- `execute` æ–¹æ³•å®ç°

**ç”Ÿæˆæ–‡ä»¶**:
- `components/commands/<command_name>.py`
- `tests/test_commands/test_<command_name>.py`

#### 1.3 Tool ç»„ä»¶ â¬œ
**ä¼˜å…ˆçº§**: é«˜

**æ¨¡æ¿å†…å®¹**:
- ç»§æ‰¿è‡ª `BaseTool`
- Tool Schema å®šä¹‰
- å‚æ•°éªŒè¯
- `run` æ–¹æ³•å®ç°

**ç”Ÿæˆæ–‡ä»¶**:
- `components/tools/<tool_name>.py`
- `tests/test_tools/test_<tool_name>.py`

#### 1.4 Event Handler ç»„ä»¶ â¬œ
**ä¼˜å…ˆçº§**: ä¸­

**æ¨¡æ¿å†…å®¹**:
- ç»§æ‰¿è‡ª `BaseEventHandler`
- äº‹ä»¶ç±»å‹å®šä¹‰
- äº‹ä»¶å¤„ç†é€»è¾‘
- ä¼˜å…ˆçº§è®¾ç½®

**ç”Ÿæˆæ–‡ä»¶**:
- `components/events/<event_name>.py`
- `tests/test_events/test_<event_name>.py`

#### 1.5 Adapter ç»„ä»¶ â¬œ
**ä¼˜å…ˆçº§**: ä¸­

**æ¨¡æ¿å†…å®¹**:
- ç»§æ‰¿è‡ª `BaseAdapter`
- è¿æ¥ç®¡ç†
- æ¶ˆæ¯å‘é€/æ¥æ”¶
- äº‹ä»¶è½¬æ¢

**ç”Ÿæˆæ–‡ä»¶**:
- `components/adapters/<adapter_name>.py`
- `tests/test_adapters/test_<adapter_name>.py`

#### 1.6 Prompt ç»„ä»¶ â¬œ
**ä¼˜å…ˆçº§**: ä½

**æ¨¡æ¿å†…å®¹**:
- Prompt æ¨¡æ¿å®šä¹‰
- å˜é‡æ›¿æ¢
- æ¡ä»¶æ¸²æŸ“

**ç”Ÿæˆæ–‡ä»¶**:
- `components/prompts/<prompt_name>.py`

#### 1.7 PlusCommand ç»„ä»¶ â¬œ
**ä¼˜å…ˆçº§**: ä½

**æ¨¡æ¿å†…å®¹**:
- ç»§æ‰¿è‡ª `BasePlusCommand`
- å¢å¼ºåŠŸèƒ½å®ç°

**ç”Ÿæˆæ–‡ä»¶**:
- `components/plus_commands/<command_name>.py`

---

## 2. ä»£ç ç”Ÿæˆå¼•æ“

### 2.1 æ¨¡æ¿æ¸²æŸ“å™¨ â¬œ
**ä»»åŠ¡**:
- [ ] æ‰©å±• `TemplateEngine` ç±»,æ”¯æŒç»„ä»¶æ¨¡æ¿
- [ ] æ·»åŠ ç»„ä»¶ç‰¹å®šçš„ä¸Šä¸‹æ–‡å‡†å¤‡å‡½æ•°
- [ ] å®ç°æ¡ä»¶æ¸²æŸ“(å¦‚æ˜¯å¦ç”Ÿæˆå¼‚æ­¥æ–¹æ³•)
- [ ] æ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿å˜é‡

**æ–‡ä»¶**: `mpdt/utils/template_engine.py`

### 2.2 ç»„ä»¶åç§°éªŒè¯å’Œè½¬æ¢ â¬œ
**ä»»åŠ¡**:
- [ ] å®ç° `validate_component_name` å‡½æ•°
- [ ] å®ç° `to_pascal_case` å‡½æ•°(å¦‚ my_action -> MyAction)
- [ ] å®ç° `to_snake_case` å‡½æ•°(å¦‚ MyAction -> my_action)
- [ ] æ£€æŸ¥ç»„ä»¶åç§°å†²çª

**æ–‡ä»¶**: `mpdt/utils/file_ops.py`

### 2.3 è¾“å‡ºè·¯å¾„ç®¡ç† â¬œ
**ä»»åŠ¡**:
- [ ] æ£€æµ‹å½“å‰æ˜¯å¦åœ¨æ’ä»¶ç›®å½•ä¸­
- [ ] æ ¹æ®ç»„ä»¶ç±»å‹ç¡®å®šè¾“å‡ºè·¯å¾„
- [ ] åˆ›å»ºå¿…è¦çš„å­ç›®å½•
- [ ] å¤„ç†æ–‡ä»¶å·²å­˜åœ¨çš„æƒ…å†µ(--force é€‰é¡¹)

**æ–‡ä»¶**: `mpdt/commands/generate.py`

---

## 3. æ’ä»¶æ³¨å†Œè‡ªåŠ¨æ›´æ–°

### 3.1 AST è§£æå’Œä¿®æ”¹ â¬œ
**ä»»åŠ¡**:
- [ ] ä½¿ç”¨ `ast` æ¨¡å—è§£æ `plugin.py`
- [ ] å®šä½ `get_plugin_components` æ–¹æ³•
- [ ] åˆ†æç°æœ‰ç»„ä»¶æ³¨å†Œä»£ç 
- [ ] ç”Ÿæˆæ–°çš„ç»„ä»¶æ³¨å†Œä»£ç 
- [ ] ä¿æŒåŸæœ‰ä»£ç æ ¼å¼

**å®ç°æ€è·¯**:
```python
import ast
import astunparse  # æˆ–ä½¿ç”¨ black æ ¼å¼åŒ–

def update_plugin_registration(plugin_file, component_info):
    # 1. è§£æ plugin.py
    with open(plugin_file) as f:
        tree = ast.parse(f.read())
    
    # 2. æ‰¾åˆ° get_plugin_components æ–¹æ³•
    for node in ast.walk(tree):
        if isinstance(node, ast.FunctionDef) and node.name == 'get_plugin_components':
            # 3. æ·»åŠ æ–°çš„ç»„ä»¶æ³¨å†Œ
            # ...
    
    # 4. ç”Ÿæˆæ–°ä»£ç 
    new_code = astunparse.unparse(tree)
    
    # 5. æ ¼å¼åŒ–ä»£ç 
    formatted = black.format_str(new_code, mode=black.Mode())
    
    # 6. å†™å›æ–‡ä»¶
    with open(plugin_file, 'w') as f:
        f.write(formatted)
```

### 3.2 Import ç®¡ç† â¬œ
**ä»»åŠ¡**:
- [ ] åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ ç»„ä»¶å¯¼å…¥
- [ ] æ£€æŸ¥å¯¼å…¥æ˜¯å¦å·²å­˜åœ¨
- [ ] ä¿æŒå¯¼å…¥é¡ºåº(æ ‡å‡†åº“ã€ç¬¬ä¸‰æ–¹åº“ã€æœ¬åœ°æ¨¡å—)
- [ ] ä½¿ç”¨ isort æ ¼å¼åŒ–å¯¼å…¥

---

## 4. æµ‹è¯•æ–‡ä»¶ç”Ÿæˆ

### 4.1 æµ‹è¯•æ¨¡æ¿ â¬œ
**ä»»åŠ¡**:
- [ ] åˆ›å»ºç»„ä»¶æµ‹è¯•åŸºç±»æ¨¡æ¿
- [ ] ç”ŸæˆåŸºæœ¬æµ‹è¯•ç”¨ä¾‹
- [ ] æ·»åŠ  Mock å¯¹è±¡é…ç½®
- [ ] åŒ…å«æµ‹è¯•ç¤ºä¾‹

**æµ‹è¯•æ–‡ä»¶ç»“æ„**:
```python
import pytest
from unittest.mock import MagicMock

from {plugin_name}.components.actions.{action_name} import {ActionName}Action

@pytest.fixture
def action():
    return {ActionName}Action()

@pytest.fixture
def mock_context():
    context = MagicMock()
    # é…ç½® mock
    return context

async def test_{action_name}_execute(action, mock_context):
    # æµ‹è¯•æ­£å¸¸æ‰§è¡Œ
    result = await action.execute(mock_context)
    assert result is not None

async def test_{action_name}_error_handling(action, mock_context):
    # æµ‹è¯•é”™è¯¯å¤„ç†
    pass
```

---

## 5. CLI é›†æˆ

### 5.1 å‘½ä»¤å‚æ•°å®Œå–„ â¬œ
**ä»»åŠ¡**:
- [ ] æ·»åŠ  `--template` é€‰é¡¹(è‡ªå®šä¹‰æ¨¡æ¿)
- [ ] æ·»åŠ  `--no-test` é€‰é¡¹(ä¸ç”Ÿæˆæµ‹è¯•æ–‡ä»¶)
- [ ] æ·»åŠ  `--force` é€‰é¡¹(è¦†ç›–å·²å­˜åœ¨æ–‡ä»¶)
- [ ] æ·»åŠ  `--dry-run` é€‰é¡¹(é¢„è§ˆç”Ÿæˆå†…å®¹)

### 5.2 äº¤äº’å¼ç”Ÿæˆ â¬œ
**ä»»åŠ¡**:
- [ ] ä½¿ç”¨ questionary åˆ›å»ºäº¤äº’å¼æµç¨‹
- [ ] è¯¢é—®ç»„ä»¶ç±»å‹
- [ ] è¯¢é—®ç»„ä»¶åç§°
- [ ] è¯¢é—®å¯é€‰é…ç½®(å¼‚æ­¥ã€æƒé™ç­‰)
- [ ] ç¡®è®¤ç”Ÿæˆ

---

## 6. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 6.1 è¿›åº¦æ˜¾ç¤º â¬œ
**ä»»åŠ¡**:
- [ ] ä½¿ç”¨ rich.progress æ˜¾ç¤ºç”Ÿæˆè¿›åº¦
- [ ] æ˜¾ç¤ºæ¯ä¸ªæ­¥éª¤çš„å®ŒæˆçŠ¶æ€
- [ ] æ¼‚äº®çš„æˆåŠŸ/é”™è¯¯æ¶ˆæ¯

### 6.2 ç”ŸæˆæŠ¥å‘Š â¬œ
**ä»»åŠ¡**:
- [ ] æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨
- [ ] æ˜¾ç¤ºä¸‹ä¸€æ­¥æ“ä½œæç¤º
- [ ] æä¾›ä»£ç ç‰‡æ®µç¤ºä¾‹

---

## å®æ–½è®¡åˆ’

### Week 1: åŸºç¡€ç»„ä»¶æ¨¡æ¿
- [ ] Day 1-2: Actionã€Commandã€Tool æ¨¡æ¿
- [ ] Day 3-4: ä»£ç ç”Ÿæˆå¼•æ“æ ¸å¿ƒåŠŸèƒ½
- [ ] Day 5: å•å…ƒæµ‹è¯•

### Week 2: é«˜çº§åŠŸèƒ½
- [ ] Day 1-2: Eventã€Adapterã€Prompt æ¨¡æ¿
- [ ] Day 3-4: AST è§£æå’Œæ’ä»¶æ³¨å†Œæ›´æ–°
- [ ] Day 5: æµ‹è¯•æ–‡ä»¶ç”Ÿæˆ

### Week 3: å®Œå–„å’Œæµ‹è¯•
- [ ] Day 1-2: CLI é›†æˆå’Œäº¤äº’å¼ç•Œé¢
- [ ] Day 3-4: ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- [ ] Day 5: é›†æˆæµ‹è¯•å’Œæ–‡æ¡£

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½æ€§
- [ ] æ‰€æœ‰ 7 ç§ç»„ä»¶ç±»å‹éƒ½èƒ½æ­£ç¡®ç”Ÿæˆ
- [ ] ç”Ÿæˆçš„ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
- [ ] è‡ªåŠ¨æ›´æ–°æ’ä»¶æ³¨å†Œä»£ç 
- [ ] æµ‹è¯•æ–‡ä»¶å¯é€‰ç”Ÿæˆ

### è´¨é‡
- [ ] ä»£ç è¦†ç›–ç‡ > 80%
- [ ] æ‰€æœ‰ç”Ÿæˆçš„ä»£ç é€šè¿‡ ruff æ£€æŸ¥
- [ ] æ‰€æœ‰ç”Ÿæˆçš„ä»£ç é€šè¿‡ mypy ç±»å‹æ£€æŸ¥

### ç”¨æˆ·ä½“éªŒ
- [ ] å‘½ä»¤å“åº”æ—¶é—´ < 2 ç§’
- [ ] æ¸…æ™°çš„é”™è¯¯æç¤º
- [ ] å‹å¥½çš„äº¤äº’ç•Œé¢
- [ ] å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£

---

## é£é™©å’ŒæŒ‘æˆ˜

### æŠ€æœ¯æŒ‘æˆ˜
1. **AST ä¿®æ”¹å¤æ‚**: ä¿æŒä»£ç æ ¼å¼å’Œé£æ ¼ä¸€è‡´æ€§
   - **ç¼“è§£**: ä½¿ç”¨æˆç†Ÿçš„å·¥å…·(black, isort)
   
2. **æ¨¡æ¿çµæ´»æ€§**: éœ€è¦æ”¯æŒå¤šç§è‡ªå®šä¹‰é€‰é¡¹
   - **ç¼“è§£**: ä½¿ç”¨ Jinja2 çš„æ¡ä»¶å’Œå¾ªç¯åŠŸèƒ½
   
3. **è·¯å¾„å¤„ç†**: è·¨å¹³å°è·¯å¾„å…¼å®¹æ€§
   - **ç¼“è§£**: ä½¿ç”¨ pathlib.Path

### ç”¨æˆ·ä½“éªŒæŒ‘æˆ˜
1. **å­¦ä¹ æ›²çº¿**: ç”¨æˆ·éœ€è¦äº†è§£å„ç§ç»„ä»¶ç±»å‹
   - **ç¼“è§£**: æä¾›è¯¦ç»†çš„å¸®åŠ©æ–‡æ¡£å’Œç¤ºä¾‹

2. **é”™è¯¯æ¢å¤**: ç”Ÿæˆå¤±è´¥æ—¶å¦‚ä½•å¤„ç†
   - **ç¼“è§£**: å®ç°äº‹åŠ¡å¼ç”Ÿæˆ,å¤±è´¥æ—¶å›æ»š

---

## ä¾èµ–

### æ–°å¢ä¾èµ–
- `astunparse` æˆ– `astor` - AST è½¬å­—ç¬¦ä¸²
- `black` - ä»£ç æ ¼å¼åŒ–
- `isort` - å¯¼å…¥æ’åº

### æ›´æ–° pyproject.toml
```toml
[project]
dependencies = [
    # ... ç°æœ‰ä¾èµ–
    "black>=23.11.0",
    "isort>=5.12.0",
]
```

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… æ·»åŠ è®¸å¯è¯ç”ŸæˆåŠŸèƒ½åˆ° `mpdt init`
2. â¬œ åˆ›å»º Action ç»„ä»¶æ¨¡æ¿
3. â¬œ å®ç°åŸºæœ¬çš„ç»„ä»¶ç”Ÿæˆé€»è¾‘
4. â¬œ æ·»åŠ å•å…ƒæµ‹è¯•
5. â¬œ å®ç°æ’ä»¶æ³¨å†Œè‡ªåŠ¨æ›´æ–°

---

**æ›´æ–°æ—¥å¿—**:
- 2025-12-13: åˆ›å»º Phase 3 è¯¦ç»†ä»»åŠ¡æ¸…å•
- 2025-12-13: å®Œæˆè®¸å¯è¯ç”ŸæˆåŠŸèƒ½å¢å¼º
